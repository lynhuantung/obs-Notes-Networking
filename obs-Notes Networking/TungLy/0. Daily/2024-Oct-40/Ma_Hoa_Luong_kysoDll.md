---
aliases:
  - Ma_Hoa_Luong_kysoDll
date: 2024-10-01
tags:
  - "#dll"
  - "#kyso-dll"
  - "#assembly"
  - "#clr"
  - "#sql"
  - "#mahoaluong"
---
# **Hướng Dẫn Ký Số DLL và Tạo Assembly trong SQL Server**


---

## **Giới thiệu**

Ký số một DLL là một bước quan trọng trong quá trình bảo mật và bảo vệ mã nguồn của bạn. Đối với các ứng dụng sử dụng SQL Server và các mã CLR (Common Language Runtime), việc ký số giúp đảm bảo rằng mã đã được xác minh và không bị thay đổi sau khi triển khai. Điều này rất quan trọng để duy trì tính toàn vẹn và an ninh của hệ thống.

---

## **Lý do cần ký số DLL**

Việc ký số DLL mang lại nhiều lợi ích, đặc biệt là trong môi trường doanh nghiệp và phát triển phần mềm:

- **Tính toàn vẹn**: Đảm bảo rằng DLL không bị thay đổi sau khi ký số, giữ nguyên tính chất của mã nguồn.
- **Bảo mật**: Ngăn chặn các mã độc hoặc mã giả mạo chèn vào ứng dụng của bạn.
- **Đáng tin cậy**: Các DLL đã ký số có thể được sử dụng an toàn trong SQL Server với các quyền hạn rõ ràng và đã được kiểm chứng.
- **Quản lý dễ dàng**: Với ký số, bạn có thể dễ dàng quản lý các phiên bản của DLL và xác minh nguồn gốc của chúng.
---
## **Các bước ký số DLL**

Dưới đây là các bước cần thực hiện để ký số một DLL (VnResource.DatabaseClr.dll) trong Visual Studio và tạo assembly từ DLL đã ký trong SQL Server.

### 1. **Kiểm tra trong Visual Studio**

- Mở dự án của bạn trong Visual Studio.
- Trong cửa sổ **Solution Explorer**, nhấp chuột phải vào project (hoặc dự án chứa DLL mà bạn đang ký số).
- Chọn **Properties**.
- Chọn tab **Signing**.
- Đảm bảo tùy chọn **Sign the assembly** đã được chọn và đúng file `.snk` được liên kết.
![[Pasted image 20241004153511.png]]

### 2. **Sử dụng lệnh `sn -vf`**

Bạn có thể sử dụng công cụ **Strong Name Tool** (`sn.exe`), được cung cấp bởi .NET SDK để xác minh chữ ký mạnh của DLL. Chạy lệnh sau từ Command Prompt:

```bash
sn -vf d:\VnResource.DatabaseClr.dll
```

Nếu DLL đã được ký thành công, bạn sẽ thấy một thông báo như sau:

`Assembly 'VnResource.DatabaseClr.dll' is valid`

Nếu chưa, sẽ có thông báo lỗi chỉ ra rằng chữ ký không hợp lệ hoặc chưa có chữ ký mạnh.

### 3. **Kiểm tra bằng cách xem manifest của assembly**

- Bạn có thể sử dụng công cụ **ILDASM** (IL Disassembler) để kiểm tra manifest của DLL. Sau khi mở DLL với ILDASM, hãy tìm phần có chứa khóa công khai (`PublicKey`) hoặc `PublicKeyToken` trong manifest của assembly. Nếu có, điều này chứng tỏ DLL đã được ký.

Để chạy ILDASM, bạn có thể thực hiện qua Command Prompt:

```bash
ildasm "d:\VnResource.DatabaseClr.dll"
```

Trong manifest của assembly, nếu bạn thấy các thông tin như sau, điều này chứng tỏ assembly đã được ký số:

`.assembly extern mscorlib {   .publickeytoken = (B7 7A 5C 56 19 34 E0 89) }`

Nếu những bước trên đều thành công, DLL của bạn đã được ký số thành công.


### 4. **Chuyển DLL sang mã hex** : Sau khi ký số thành công, cần chuyển đổi DLL thành mã hex để sử dụng trong SQL Server
- Mở Power Shell quyền administrator
- Sau đó sinh ra file output_hex.txt chứa mã hex

```bash
# Đường dẫn tới file DLL
$dllPath = "d:\VnResource.DatabaseClr.dll"

# Đọc file DLL dưới dạng byte array
[byte[]]$dllBytes = Get-Content $dllPath -Encoding Byte

# Chuyển từng byte sang định dạng hex và nối thành một chuỗi lớn, thêm prefix "0x"
$hexString = "0x" + ($dllBytes | ForEach-Object { $_.ToString("X2") }) -join ""

# In ra hoặc lưu lại kết quả
Write-Output $hexString

# Lưu chuỗi hex vào file nếu cần
Set-Content -Path "d:\output_hex.txt" -Value $hexString

```


### 5. **Tạo assembly trong sql**
- Mở **SQL Server Management Studio (SSMS)**, chạy lệnh sau để kích hoạt CLR:
- Đặt Trustworthy cho database
- Tạo assembly từ file DLL đã ký số và chuyển đổi
```sql
---- Drop before Install
--DROP FUNCTION [dbo].[VnrDecrypt]
--DROP FUNCTION [dbo].[VnrEncrypt]
--GO
--DROP FUNCTION [dbo].[SalParse]
--GO
--DROP ASSEMBLY [VnResource.DatabaseClr]
--GO

--Must sp_configure allow updates to 0
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
	EXEC sp_configure 'allow updates', 0
GO
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
	RECONFIGURE
GO

--Must sp_configure clr to 1
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
	EXEC sp_configure 'clr enabled', 1
GO
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
	RECONFIGURE
GO
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
	EXEC sp_configure 'clr enabled'
GO

--SET TRUSTWORTHY ON
declare @dbName nvarchar(1000) = (select DB_NAME())
set @dbName = 'ALTER DATABASE ' + @dbName+' SET TRUSTWORTHY ON'
exec sp_executesql  @dbName
GO

--Add Assembly VnResource.DatabaseClr
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
BEGIN
	declare @asmBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103007B6DFF660000000000000000E00022200B0130000018000000060000000000004E360000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000091230000030040850000100000100000000010000010000000000000100000000000000000000000FC3500004F00000000400000E002000000000000000000000000000000000000006000000C000000C43400001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000054160000002000000018000000020000000000000000000000000000200000602E72737263000000E00200000040000000040000001A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001E0000000000000000000000000000400000420000000000000000000000000000000030360000000000004800000002000500082500003C0F0000090000000000000000000000000000004434000080000000000000000000000000000000000000000000000000000000000000000000000046731B000006026F10000006730600000A2A46731B000006026F08000006730600000A2AA6720100007003280700000A2C0B7E0800000A730600000A2A731B000006026F10000006730600000A2A1E02280900000A2A3A0203027B04000004280A0000062A3A0203027B0400000428090000062A1330030011000000010000110203281A0000060A020604280A0000062A000000133003001100000001000011020304280E0000060A020628170000062A3A0203027B04000004280E0000062A3A0203027B04000004280D0000062A001330030011000000010000110203281A0000060A020604280E0000062A0000001B300400B700000002000011140A027B05000004046F0A00000A2C0F027B05000004046F0B00000A0A2B4902027B03000004281A0000060B0407730C00000A0C280D00000A25081F206F0E00000A6F0F00000A25081F106F0E00000A6F1000000A6F1100000A0A027B0500000404066F1200000A731300000A0D090617731400000A130411040316038E696F1500000A11046F1600000A11046F1700000ADE0C11042C0711046F1800000ADC096F1900000A1305DE0A092C06096F1800000ADC11052A00011C0000020078001C94000C0000000002006E003CAA000A000000003A0203027B0400000428120000062A3A0203027B0400000428110000062A000013300300110000000100001102030428150000060A020628190000062A00000013300300110000000100001102030428160000060A020628190000062A3A0203027B0400000428160000062A3A0203027B0400000428150000062A00133003001100000001000011020328180000060A02060428160000062A0000001B300400F700000003000011032C0803280100002B2D02032A00140A027B06000004046F0A00000A2C0F027B06000004046F0B00000A0A2B5702027B03000004281A0000060B0407730C00000A0C280D00000A25081F206F0E00000A6F0F00000A25081F106F0E00000A6F1000000A6F1B00000A0A027B06000004046F0A00000A2D0D027B0600000404066F1200000A731300000A0D090617731400000A130411040316038E696F1500000A11046F1600000A11046F1700000ADE0C11042C0711046F1800000ADC096F1900000A1305DE2E092C06096F1800000ADC130611066F1C00000A7284000070281D00000A2C0C02030428160000061305DE0311067A11052A0001280000020094001CB0000C0000000002008A003CC6000A0000000000000E00C2D000240E0000011E03281E00000A2A52032D077E0800000A2B0103100103281F00000A2A36027B02000004036F2000000A2A6A032D077E0800000A2B01031001027B02000004036F2100000A2A000013300300B100000000000000027E0A000004252D17267E09000004FE061E000006732200000A25800A0000046F2300000A7D02000004027E0B000004252D17267E09000004FE061F000006732400000A25800B0000046F2500000A7D03000004027E0C000004252D17267E09000004FE0620000006732400000A25800C0000046F2500000A7D0400000402732600000A7D0500000402732600000A7D0600000402730900000A7D0700000402730900000A7D0800000402280900000A2A2E731D00000680090000042A1A282700000A2A1A72EE0000702A0042534A4201000100000000000C00000076342E302E33303331390000000005006C0000009C050000237E0000080600008005000023537472696E677300000000880B000004010000235553008C0C00001000000023475549440000009C0C0000A002000023426C6F620000000000000002000001571D0208090A000000FA013300160000010000001A000000060000000C00000020000000200000002700000001000000070000000300000003000000010000000300000002000000010000000000510201000000000006009701A0030600B701A00306006E018D030F00C003000006007C048F020A0082012E030A000502CF030600DC01C00406006100A5000600A9024005060011044005060079027B0006006C0240050600FD028F0206005301A003060033008F02060032028F0206004802400506001904400506009602400506007F027B000600DC004005060017018F020E000C01070306003A00A5000600B8048F0200000000720000000000010001000100100067040000150001000100010010002403490315000100050000001000CD004903150001000600020010001303000015000200070003211000A1000000150009001C0053803F021B002100D5010902210083041B002100C4001B000100E8020D020100D3020D020100950416020100BA02160236006E001902160001001D0216001A0025021600480025025020000000009600A2042C0201006220000000009600AD042C02020074200000000096003D01320203009E200000000086186003060005009E200000000086186003060005009E20000000008618600306000500A6200000000086001F02B3000500B5200000000086001F0239020600C4200000000086001F023E020700E4200000000086001F024402090001210000000086004F044B020B0010210000000086004F04B9000C0020210000000086004F0452020D0040210000000086004F0459020F0020220000000086000F02B30011002F220000000086000F023902120040220000000086000F023E02130060220000000086000F02440215007D2200000000860040044B0217008C220000000086004004B90018009C22000000008600400452021900BC22000000008600400459021B00E823000000008100CC04B3001D00F023000000008100E403B9001E000524000000008100F604B3001F0013240000000081002504B90020003024000000008618600306002100ED240000000091186603610221009E20000000008618600306002100F9240000000083000B006502210000250000000083002400A300210000250000000083005200A3002100000001000F05000001001B05000001000F05000002003C0500000100050400000100EB0400000100EB0400000200C40000000100050400000200C40000000100050400000100EB0400000100EB0400000200C40000000100050400000200C40000000100F60300000100DD0400000100DD0400000200C40000000100F60300000200C40000000100F60300000100DD0400000100DD0400000200C40000000100F60300000200C40000000100F60300000100DD04000001003404000001000405090060030100110060030600190060030A00310060030600790060030600390060031000890069051500890077051B002900600306000C0030053A000C0086024000590060034700910046014E0099005E045300A10028055900A10085005900A1007D035F000C00C0006400610060030600690060036C00A9004D017600A90039020600A9002F010600B90035010600610020057E00C1008F049400A1006D035F007100F900A30089005D051500D100F601A700D100E501AD0041002F02B30041005E04B90014006003C60014000501CC001C006003C6001C000501CC000C00600306004100ED00D7000E0004008701200023009B022E000B006A022E00130073022E001B009202400023009B02600023009B02C3002B009B021E00230083003200BF00D10004800000000000000000000001000000E50049030000040000000000000000000000DC00980000000000040000000000000000000000DC008C0000000000040000000000000000000000DC00230100000000050003000600050035009F000000003C3E395F5F32375F30003C2E63746F723E625F5F32375F30003C3E395F5F32375F31003C2E63746F723E625F5F32375F310046756E6360310049456E756D657261626C656031003C3E395F5F32375F32003C2E63746F723E625F5F32375F320044696374696F6E6172796032003C3E39003C4D6F64756C653E0053797374656D2E494F007365745F49560053797374656D2E44617461006D73636F726C6962003C3E630053797374656D2E436F6C6C656374696F6E732E47656E65726963004164640070617373776F726400446566696E655265736F757263650043727970746F53747265616D4D6F6465006765745F556E69636F6465006765745F4D65737361676500496E766F6B6500456E756D657261626C650049446973706F7361626C650053797374656D2E436F726500436C6F736500446973706F73650053616C50617273650043726561746500577269746500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C46756E6374696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650064656661756C74456E636F64696E670046726F6D426173653634537472696E6700546F426173653634537472696E670053716C537472696E670044656372797074546F537472696E6700456E6372797074546F537472696E6700476574537472696E6700466C757368004B6579436865636B0052696A6E6461656C00566E5265736F757263652E4461746162617365436C722E646C6C0043727970746F53747265616D004D656D6F727953747265616D006765745F4974656D0053797374656D0053796D6D6574726963416C676F726974686D004943727970746F5472616E73666F726D005F6C6F636B446563727970746F72436F6C6C656374696F6E005F646563727970746F72436F6C6C656374696F6E005F656E63727970746F72436F6C6C656374696F6E00457863657074696F6E0053797374656D2E4C696E71004461746143727970746F48656C70657200566E7248656C706572004D6963726F736F66742E53716C5365727665722E53657276657200566E5265736F757263652E4461746162617365436C72002E63746F72002E6363746F7200437265617465446563727970746F7200437265617465456E63727970746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C547970657300476574456E63727970746564427974657300656E63727970746564427974657300736F7572636542797465730050617373776F72644465726976654279746573004765744E6F726D616C4279746573006E6F726D616C42797465730044656372797074546F427974657300456E6372797074546F42797465730047657442797465730055736572446566696E656446756E6374696F6E73004F626A6563740064656661756C7453616C7400436F756E74005F6C6F636B4465637279707400566E724465637279707400566E72456E637279707400436F6E766572740053797374656D2E5465787400476574456E637279707465645465787400656E637279707465645465787400736F7572636554657874004765744E6F726D616C54657874006E6F726D616C5465787400656E637279707454657874007465787400546F4172726179007365745F4B657900436F6E7461696E734B6579006B65790053797374656D2E53656375726974792E43727970746F677261706879006F705F457175616C697479006F705F496E657175616C69747900456D7074790000000000808166006600360036003300390037003400360066003400320034003900310063003700360062006300300034003200300063003100640061003600390033003600630031003300390035003200640035006100620032003000630033003000320066003100340030006100330032003300370031003800330031006200340030000069500061006400640069006E006700200069007300200069006E00760061006C0069006400200061006E0064002000630061006E006E006F0074002000620065002000720065006D006F007600650064002000280056006E007200480065006C007000650072002900001340002100400026002600210026002A0026000000002846DF07DD60374BB57BF04E98A4637700042001010803200001052001011111042001010E050002020E0E02060E0407011D050E070612291D05122D123112351D0507151225020E122905200102130006200113011300062002010E1D0504000012490520011D0508052001011D050420001229072002011300130109200301125512291159072003011D0508080420001D0510070712291D05122D123112351D0512390A10010108151265011E00030A01050320000E0500010E1D050500011D050E0520010E1D050520011D050E06151241011221052002011C18042000130005151241010E040000122108B77A5C561934E08980A0002400000480000094000000060200000024000052534131000400000100010021B9F12494B965D08FE7D16E3AA0D22548A56B76C10D4842AB0226D46353CC2DB83A640441C5F7DE14A5AE1855785E2FA44F002886B72C32EB200FCC0574B5D66834652D87F4FAA2BD348414E2648C1E35F752BAB67B9B1F861F99F33A3A71C9B4962152002B888D6B18BBB5DFF71703596B02FCAB48E4EB0B4BE4DFF3FABCB380806600660036003600330039003700340036006600340032003400390031006300370036006200630030003400320030006300310064006100360039003300360063003100330039003500320064003500610062003200300063003300300032006600310034003000610033003200330037003100380033003100620034003000030612210806151225020E122902061C0306121807061512410112210606151241010E050001111D0E060002111D0E0E0420010E0E0520020E0E0E0620020E1D050E0620011D051D050620021D050E0E0720021D051D050E0300000104200012210801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010002000000000004010000003721CD89D9EC52FBEF0826BE8A271AB811DED91D0B4BED6336CFD492BD791D555C99B861C500C633A4FC860099C48B49808FFCA7888795C49071E3D3B942C47AE1C13C852E86D02A5E758C410FE7F92462BFA75077225CA8F4AF44B5378C4251CC4DCCF00EA6A6511C6FD0FDC0C6C51CC8C7298124F6E38A10C15AE841ECEE18000000007B6DFF6600000000020000001C010000E0340000E016000052534453D4B63540B1938246923972239BFFEC3601000000443A5C436F64655C4769745F4672616D65776F726B5C4672616D65576F726B5C332E446576656C6F706D656E745C566E5265736F757263652E4461746162617365436C725C6F626A5C52656C656173655C566E5265736F757263652E4461746162617365436C722E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002436000000000000000000003E36000000200000000000000000000000000000000000000000000030360000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000840200000000000000000000840234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004E4010000010053007400720069006E006700460069006C00650049006E0066006F000000C001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000056001B00010049006E007400650072006E0061006C004E0061006D006500000056006E005200650073006F0075007200630065002E004400610074006100620061007300650043006C0072002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005E001B0001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000056006E005200650073006F0075007200630065002E004400610074006100620061007300650043006C0072002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000503600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
	DECLARE @hash varbinary(64);
	SELECT @hash = HASHBYTES('SHA2_512', @asmBin);

	IF( NOT EXISTS(SELECT TOP 1 1 FROM sys.trusted_assemblies WHERE [hash] = @hash))
		EXEC sys.sp_add_trusted_assembly @hash

	CREATE ASSEMBLY [VnResource.DatabaseClr]
    AUTHORIZATION [dbo]
    FROM @asmBin
    WITH PERMISSION_SET = SAFE;
END

GO

--CREATE Function VnrDecrypt
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
BEGIN
	EXEC sp_executesql N'CREATE FUNCTION [dbo].[VnrDecrypt] (@encryptText NVARCHAR (MAX)) RETURNS NVARCHAR (MAX) AS EXTERNAL NAME [VnResource.DatabaseClr].[UserDefinedFunctions].[VnrDecrypt]'
	EXEC sp_executesql N'CREATE FUNCTION [dbo].[VnrEncrypt] (@encryptText NVARCHAR (MAX)) RETURNS NVARCHAR (MAX) AS EXTERNAL NAME [VnResource.DatabaseClr].[UserDefinedFunctions].[VnrEncrypt]'
END

GO

--CREATE Function SalParse
DECLARE @SqlVersion INT = CAST(LEFT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)),CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - 1) + '.' + REPLACE(RIGHT(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)), LEN(CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max))) - CHARINDEX('.',CAST(SERVERPROPERTY('ProductVersion') AS nvarchar(max)))),'.','') AS numeric(18,10))
IF(@SqlVersion >= 11) -- Version must >= SQL 2012
BEGIN
	EXEC sp_executesql N'CREATE FUNCTION [dbo].[SalParse] (@encryptText NVARCHAR (MAX), @key NVARCHAR (MAX)) RETURNS NVARCHAR (MAX) AS EXTERNAL NAME [VnResource.DatabaseClr].[UserDefinedFunctions].[SalParse]'
END


```

- Kết quả : kiểm tra assembly vừa tạo đã được ký chưa => trả ra true là đã ký
![[Pasted image 20241004154228.png]]

---
#### **Kết luận**

Việc ký số DLL giúp tăng cường tính bảo mật và đảm bảo rằng các thành phần của hệ thống được triển khai an toàn. Thực hiện đầy đủ các bước trên sẽ giúp bạn hoàn tất việc ký số và tạo assembly trong SQL Server một cách chính xác và hiệu quả.